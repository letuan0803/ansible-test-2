- name: Install NGINX Ingress Controller using Helm
  hosts: k8s_master
  gather_facts: false
  become: true
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install required system packages
      apt:
        name:
          - python3-pip
          - python3-venv
          - curl
          - gnupg
          - apt-transport-https
        state: present

    - name: Install pip packages for Kubernetes interaction
      pip:
        name:
          - openshift
          - kubernetes
        executable: pip3

    - name: Pull the NGINX Ingress Controller chart
      ansible.builtin.command:
        cmd: helm pull oci://ghcr.io/nginx/charts/nginx-ingress --version 2.1.0 --untar
      args:
        chdir: /tmp
      creates: /tmp/nginx-ingress

    - name: Create a namespace for the ingress controller
      community.kubernetes.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: nginx-ingress

    - name: Install the NGINX Ingress Controller
      community.kubernetes.helm:
        name: nginx-ingress
        chart_ref: /tmp/nginx-ingress
        release_namespace: nginx-ingress
        create_namespace: false
        values:
          controller:
            replicaCount: 2
            service:
              type: NodePort
              nodePort: 30080